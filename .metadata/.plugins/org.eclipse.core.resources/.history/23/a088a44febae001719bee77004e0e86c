package Microbe;

import java.io.FileInputStream;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Scanner;

class Solution {
	static int Answer;
	static int N, M, K;
	static int[][] map;
	static HashMap<Integer, Crowd> hashmap = new HashMap<>();
	static HashMap<Integer, Crowd> secondMap = new HashMap<>();
	
	public static void main(String args[]) throws Exception	{
//		Scanner sc = new Scanner(System.in);
		Scanner sc = new Scanner(new FileInputStream("sample_input.txt"));

		int T = sc.nextInt();
		for(int test_case = 0; test_case < T; test_case++) {
			Answer = 0;
			
			N = sc.nextInt(); //map 크기
			M = sc.nextInt(); //격리시간
			K = sc.nextInt(); //군집수
			map = new int[N][N];
			
			//군집 -> HashMap으로 표현
			for (int i = 0; i < K; i++) {
				int x = sc.nextInt();
				int y = sc.nextInt();
				hashmap.put(x * N + y, new Crowd(sc.nextInt(), sc.nextInt()));
			}

			
			//M 시간 후 -> M번 로직 수행
			for (int i = 0; i < M; i++) {
				Iterator iter = hashmap.keySet().iterator();
				
				while (iter.hasNext()) {
					int tempKey = (int) iter.next();
					int x = tempKey / N, y = tempKey % N;
					Crowd tempVal = hashmap.get(tempKey);
					
					//이동
					switch (tempVal.direction) {
					case 1: //상
						if (x == 0) {
							tempVal.num = tempVal.num / 2;
							tempVal.direction = 2;
							secondMap.put(y, new Crowd(tempVal.num, tempVal.direction));
						} else {
							if (canInsert((--x) * N + y, tempVal)) { // 중복 아닌 경우 t, 중복이어도 가장 tempVal.num이 크면 t
								secondMap.put((--x) * N + y, tempVal);
							}
						}
						break;
						
					case 2: //하
						if (x == N - 1) {
							tempVal.num = tempVal.num / 2;
							tempVal.direction = 1;
							secondMap.put((N - 1) * N + y, new Crowd(tempVal.num, tempVal.direction));
						} else {
							if (canInsert((++x) * N + y, tempVal)) {
								secondMap.put((++x) * N + y, tempVal);
							}
						}
						break;
						
					case 3: //좌
						if (y == 0) {
							tempVal.num = tempVal.num / 2;
							tempVal.direction = 4;
							secondMap.put(x * N, new Crowd(tempVal.num, tempVal.direction));
						} else {
							if (canInsert(x * N + (--y), tempVal)) {
								secondMap.put(x * N + (--y), tempVal);
							}
						}
						break;
						
					case 4: //우
						if (y == N - 1) {
							tempVal.num = tempVal.num / 2;
							tempVal.direction = 3;
							secondMap.put(x * N + N - 1, new Crowd(tempVal.num, tempVal.direction));
						} else {
							if (canInsert(x * N + (++y), tempVal)) {
								secondMap.put(x * N + (++y), tempVal);
							}
						}
						break;
						
					}
				
				}
				
				HashMap<Integer, Crowd> tempMap = new HashMap<>();
				hashmap = secondMap;
				secondMap = tempMap;
			}
			
			
			//미생물 총 합 구하기(iter)
			Iterator iter = secondMap.keySet().iterator();
			while (iter.hasNext()) {
				Answer += secondMap.get(iter.next()).num;
			}
			
			// Print the answer to standard output(screen).
			System.out.print("#" + (test_case+1) + " ");
			System.out.println(Answer);
		}
	}
	
	static boolean canInsert(int key, Crowd val) {
		if (secondMap.containsKey(key)) {
			if (val.num > secondMap.get(key).num) {
				return true;
			} else {
				return false;
			}
		} else {
			return true;
		}
	}
	
	static class Crowd {
		int num;
		int direction;
		
		public Crowd(int num, int direction) {
			this.num = num;
			this.direction = direction;
		}
	}
}
